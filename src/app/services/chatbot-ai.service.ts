import { Injectable } from '@angular/core';
import { BehaviorSubject, Observable } from 'rxjs';

export interface ChatMessage {
  id: string;
  sender: 'user' | 'bot';
  message: string;
  timestamp: Date;
  type?: 'text' | 'quick_reply' | 'carousel' | 'action';
  metadata?: any;
  sentiment?: 'positive' | 'negative' | 'neutral';
  confidence?: number;
  rating?: 'positive' | 'negative';
}

export interface ConversationContext {
  userId?: string;
  sessionId: string;
  topic?: string;
  userName?: string;
  userEmail?: string;
  serviceInterest?: string;
  urgency?: 'low' | 'medium' | 'high';
  previousQuestions?: string[];
  conversationStage?: 'greeting' | 'discovery' | 'qualification' | 'proposal' | 'closing';
  leadScore?: number;
  lastActivity?: Date;
  preferences?: {
    language: string;
    communicationStyle: 'formal' | 'casual';
    responseLength: 'short' | 'detailed';
  };
}

export interface QuickReply {
  text: string;
  payload: string;
  icon?: string;
}

export interface CarouselItem {
  title: string;
  subtitle: string;
  imageUrl?: string;
  buttons: QuickReply[];
}

@Injectable({
  providedIn: 'root'
})
export class ChatbotAiService {
  private conversationHistory = new BehaviorSubject<ChatMessage[]>([]);
  private context = new BehaviorSubject<ConversationContext>({
    sessionId: this.generateSessionId(),
    conversationStage: 'greeting',
    leadScore: 0,
    preferences: {
      language: 'pt',
      communicationStyle: 'casual',
      responseLength: 'detailed'
    }
  });

  // Expanded knowledge base with more sophisticated content
  private knowledgeBase: {
    services: {
      [key: string]: {
        keywords: string[];
        description: string;
        technologies: string[];
        projects: string[];
        pricing: string;
        timeline: string;
      }
    };
    faqs: Array<{
      question: string;
      answer: string;
      keywords: string[];
    }>;
    companyInfo: {
      name: string;
      founded: string;
      location: string;
      team: string;
      projects: string;
      specialties: string[];
      contact: {
        email: string;
        whatsapp: string;
        website: string;
      }
    };
  } = {
    services: {
      web: {
        keywords: ['desenvolvimento web', 'sites', 'aplica√ß√µes web', 'e-commerce', 'landing pages', 'frontend', 'backend', 'fullstack'],
        description: 'Desenvolvimento de aplica√ß√µes web modernas e responsivas',
        technologies: ['React', 'Angular', 'Vue.js', 'Node.js', 'Python', 'PHP'],
        projects: ['E-commerce para varejo', 'Sistema de gest√£o empresarial', 'Plataforma de cursos online'],
        pricing: 'A partir de R$ 5.000',
        timeline: '2-6 meses'
      },
      mobile: {
        keywords: ['apps mobile', 'aplicativos', 'ios', 'android', 'react native', 'flutter', 'app'],
        description: 'Desenvolvimento de aplicativos m√≥veis nativos e h√≠bridos',
        technologies: ['React Native', 'Flutter', 'Swift', 'Kotlin'],
        projects: ['App de delivery', 'App banc√°rio', 'App de fitness'],
        pricing: 'A partir de R$ 8.000',
        timeline: '3-8 meses'
      },
      cloud: {
        keywords: ['aws', 'azure', 'google cloud', 'nuvem', 'infraestrutura', 'cloud computing', 'devops'],
        description: 'Consultoria e implementa√ß√£o de solu√ß√µes em nuvem',
        technologies: ['AWS', 'Azure', 'Google Cloud', 'Docker', 'Kubernetes'],
        projects: ['Migra√ß√£o para AWS', 'Arquitetura serverless', 'CI/CD pipeline'],
        pricing: 'A partir de R$ 3.000',
        timeline: '1-4 meses'
      },
      security: {
        keywords: ['seguran√ßa', 'ciberseguran√ßa', 'pentest', 'auditoria', 'compliance', 'lgpd'],
        description: 'Solu√ß√µes completas de seguran√ßa da informa√ß√£o',
        technologies: ['Penetration Testing', 'SIEM', 'Firewall', 'Compliance LGPD'],
        projects: ['Auditoria de seguran√ßa', 'Implementa√ß√£o LGPD', 'Pentest aplica√ß√µes'],
        pricing: 'A partir de R$ 4.000',
        timeline: '2-6 meses'
      },
      ai: {
        keywords: ['intelig√™ncia artificial', 'machine learning', 'ia', 'automa√ß√£o', 'chatbots', 'deep learning'],
        description: 'Implementa√ß√£o de solu√ß√µes de IA e automa√ß√£o',
        technologies: ['TensorFlow', 'PyTorch', 'OpenAI', 'Scikit-learn'],
        projects: ['Chatbot inteligente', 'Sistema de recomenda√ß√£o', 'An√°lise preditiva'],
        pricing: 'A partir de R$ 10.000',
        timeline: '4-12 meses'
      },
      consulting: {
        keywords: ['consultoria', 'assessoria', 'mentoria', 'treinamento', 'transforma√ß√£o digital'],
        description: 'Consultoria estrat√©gica em tecnologia e transforma√ß√£o digital',
        technologies: ['Metodologias √°geis', 'Design Thinking', 'Lean Startup'],
        projects: ['Estrat√©gia digital', 'Treinamento de equipes', 'Mentoria t√©cnica'],
        pricing: 'A partir de R$ 2.000',
        timeline: '1-3 meses'
      }
    },
    
    faqs: [
      {
        question: 'Quanto tempo leva para desenvolver um projeto?',
        answer: 'O tempo varia conforme a complexidade. Projetos simples levam 1-3 meses, m√©dios 3-6 meses, e complexos 6-12 meses. Fazemos um cronograma detalhado ap√≥s an√°lise dos requisitos.',
        keywords: ['tempo', 'prazo', 'cronograma', 'dura√ß√£o']
      },
      {
        question: 'Voc√™s oferecem suporte ap√≥s a entrega?',
        answer: 'Sim! Oferecemos 3 meses de suporte gratuito ap√≥s a entrega, incluindo corre√ß√µes de bugs e pequenos ajustes. Tamb√©m temos planos de manuten√ß√£o cont√≠nua.',
        keywords: ['suporte', 'manuten√ß√£o', 'p√≥s-entrega', 'garantia']
      },
      {
        question: 'Como funciona o processo de desenvolvimento?',
        answer: 'Seguimos metodologia √°gil: 1) An√°lise de requisitos, 2) Prototipagem, 3) Desenvolvimento iterativo, 4) Testes, 5) Deploy, 6) Suporte. Voc√™ acompanha todo o processo.',
        keywords: ['processo', 'metodologia', 'desenvolvimento', 'etapas']
      },
      {
        question: 'Voc√™s trabalham com que tecnologias?',
        answer: 'Trabalhamos com tecnologias modernas: React, Angular, Vue.js, Node.js, Python, AWS, Azure, React Native, Flutter, e muito mais. Escolhemos a melhor stack para cada projeto.',
        keywords: ['tecnologias', 'stack', 'linguagens', 'frameworks']
      }
    ],

    companyInfo: {
      name: 'Ars Machina Consultancy',
      founded: '2023',
      location: 'S√£o Lu√≠s, Maranh√£o',
      team: '30+ especialistas',
      projects: '200+ projetos entregues',
      specialties: ['Desenvolvimento Full-Stack', 'Cloud Computing', 'IA & Machine Learning', 'Ciberseguran√ßa'],
      contact: {
        email: 'contato@arsmachinaconsultancy.com',
        whatsapp: '+55 98 99964-9215',
        website: 'www.arsmachinaconsultancy.com'
      }
    }
  };

  // Sentiment analysis patterns
  private sentimentPatterns = {
    positive: ['√≥timo', 'excelente', 'perfeito', 'adorei', 'fant√°stico', 'maravilhoso', 'incr√≠vel', 'legal', 'bom', 'gostei'],
    negative: ['ruim', 'p√©ssimo', 'horr√≠vel', 'terr√≠vel', 'n√£o gostei', 'problema', 'erro', 'dif√≠cil', 'complicado', 'caro'],
    neutral: ['ok', 'normal', 'regular', 'mais ou menos', 'talvez', 'n√£o sei', 'pode ser']
  };

  // Conversation patterns for better intent recognition
  private conversationPatterns = {
    questions: ['como', 'qual', 'quando', 'onde', 'quem', 'quanto', 'por que', 'o que', 'posso', 'consigo'],
    requests: ['quero', 'preciso', 'gostaria', 'posso', 'tem como', '√© poss√≠vel', 'me ajuda', 'ajude-me'],
    problems: ['problema', 'erro', 'dificuldade', 'n√£o funciona', 'n√£o consigo', 'bug', 'falha'],
    comparisons: ['melhor', 'comparado', 'diferen√ßa', 'versus', 'vs', 'ou', 'entre'],
    urgency: ['urgente', 'r√°pido', 'imediatamente', 'hoje', 'agora', 'pressa'],
    pricing: ['pre√ßo', 'custo', 'valor', 'or√ßamento', 'quanto custa', 'investimento'],
    timeline: ['prazo', 'tempo', 'quando', 'cronograma', 'dura√ß√£o']
  };

  constructor() {
    // N√£o inicializa automaticamente - deixa o componente controlar
  }

  private generateSessionId(): string {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  private initializeSession(): void {
    const userLanguage = this.getUserLanguage();
    const welcomeMessage: ChatMessage = {
      id: this.generateMessageId(),
      sender: 'bot',
      message: userLanguage === 'en' 
        ? 'üëã Hello! I\'m the intelligent assistant from Ars Machina Consultancy. How can I help you today?'
        : 'üëã Ol√°! Eu sou o assistente inteligente da Ars Machina Consultancy. Como posso ajudar voc√™ hoje?',
      timestamp: new Date(),
      type: 'text'
    };
    
    this.conversationHistory.next([welcomeMessage]);
  }

  private getUserLanguage(): 'pt' | 'en' {
    const saved = localStorage.getItem('ars-machina-user-prefs');
    if (saved) {
      const prefs = JSON.parse(saved);
      return prefs.language || 'pt';
    }
    return navigator.language.startsWith('en') ? 'en' : 'pt';
  }

  private generateMessageId(): string {
    return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  getConversationHistory(): Observable<ChatMessage[]> {
    return this.conversationHistory.asObservable();
  }

  getContext(): Observable<ConversationContext> {
    return this.context.asObservable();
  }

  async processMessage(userMessage: string): Promise<ChatMessage> {
    const userMsg: ChatMessage = {
      id: this.generateMessageId(),
      sender: 'user',
      message: userMessage,
      timestamp: new Date(),
      type: 'text',
      sentiment: this.analyzeSentiment(userMessage)
    };

    // Add user message to history
    const currentHistory = this.conversationHistory.value;
    this.conversationHistory.next([...currentHistory, userMsg]);

    // Update context
    this.updateContext(userMessage);

    // Generate intelligent response
    const botResponse = await this.generateIntelligentResponse(userMessage);

    // Add bot response to history
    const updatedHistory = this.conversationHistory.value;
    this.conversationHistory.next([...updatedHistory, botResponse]);

    return botResponse;
  }

  private analyzeSentiment(message: string): 'positive' | 'negative' | 'neutral' {
    const lowerMessage = message.toLowerCase();
    
    let positiveScore = 0;
    let negativeScore = 0;

    this.sentimentPatterns.positive.forEach(word => {
      if (lowerMessage.includes(word)) positiveScore++;
    });

    this.sentimentPatterns.negative.forEach(word => {
      if (lowerMessage.includes(word)) negativeScore++;
    });

    if (positiveScore > negativeScore) return 'positive';
    if (negativeScore > positiveScore) return 'negative';
    return 'neutral';
  }

  private updateContext(message: string): void {
    const currentContext = this.context.value;
    const lowerMessage = message.toLowerCase();

    // Update service interest
    for (const [service, data] of Object.entries(this.knowledgeBase.services)) {
      if (data.keywords.some(keyword => lowerMessage.includes(keyword))) {
        currentContext.serviceInterest = service;
        break;
      }
    }

    // Update urgency
    if (this.conversationPatterns.urgency.some(word => lowerMessage.includes(word))) {
      currentContext.urgency = 'high';
    }

    // Update conversation stage
    if (currentContext.conversationStage === 'greeting' && currentContext.serviceInterest) {
      currentContext.conversationStage = 'discovery';
    }

    // Extract user name if mentioned
    const nameMatch = lowerMessage.match(/meu nome √© (\w+)|me chamo (\w+)|sou (\w+)/);
    if (nameMatch) {
      currentContext.userName = nameMatch[1] || nameMatch[2] || nameMatch[3];
    }

    // Extract email if mentioned
    const emailMatch = lowerMessage.match(/[\w.-]+@[\w.-]+\.\w+/);
    if (emailMatch) {
      currentContext.userEmail = emailMatch[0];
    }

    // Update lead score
    this.updateLeadScore(currentContext, message);

    currentContext.lastActivity = new Date();
    this.context.next(currentContext);
  }

  private updateLeadScore(context: ConversationContext, message: string): void {
    const lowerMessage = message.toLowerCase();
    
    // Increase score for engagement indicators
    if (this.conversationPatterns.requests.some(word => lowerMessage.includes(word))) {
      context.leadScore = (context.leadScore || 0) + 10;
    }
    
    if (this.conversationPatterns.pricing.some(word => lowerMessage.includes(word))) {
      context.leadScore = (context.leadScore || 0) + 15;
    }
    
    if (context.userEmail) {
      context.leadScore = (context.leadScore || 0) + 20;
    }
    
    if (context.userName) {
      context.leadScore = (context.leadScore || 0) + 10;
    }
  }

  private async generateIntelligentResponse(message: string): Promise<ChatMessage> {
    const context = this.context.value;
    const intent = this.analyzeAdvancedIntent(message);
    const confidence = this.calculateConfidence(message, intent);

    let response: any = {
      id: this.generateMessageId(),
      sender: 'bot' as const,
      timestamp: new Date(),
      confidence: confidence
    };

    switch (intent) {
      case 'greeting':
        response = { ...response, ...this.handleAdvancedGreeting(context) };
        break;
      case 'service_inquiry':
        response = { ...response, ...this.handleAdvancedServiceInquiry(message, context) };
        break;
      case 'pricing':
        response = { ...response, ...this.handleAdvancedPricing(message, context) };
        break;
      case 'timeline':
        response = { ...response, ...this.handleTimelineInquiry(message, context) };
        break;
      case 'contact':
        response = { ...response, ...this.handleAdvancedContact(context) };
        break;
      case 'faq':
        response = { ...response, ...this.handleFAQ(message) };
        break;
      case 'project_details':
        response = { ...response, ...this.handleProjectDetails(message, context) };
        break;
      case 'qualification':
        response = { ...response, ...this.handleQualification(message, context) };
        break;
      default:
        response = { ...response, ...this.handleIntelligentDefault(message, context) };
    }

    return response;
  }

  private analyzeAdvancedIntent(message: string): string {
    const lowerMessage = message.toLowerCase();

    // Advanced intent recognition with context awareness
    if (this.isGreeting(lowerMessage)) return 'greeting';
    if (this.containsKeywords(lowerMessage, this.conversationPatterns.pricing)) return 'pricing';
    if (this.containsKeywords(lowerMessage, this.conversationPatterns.timeline)) return 'timeline';
    if (this.containsKeywords(lowerMessage, ['contato', 'telefone', 'email', 'whatsapp', 'falar'])) return 'contact';
    if (this.containsKeywords(lowerMessage, ['projeto', 'desenvolvimento', 'criar', 'fazer'])) return 'project_details';
    if (this.containsKeywords(lowerMessage, ['empresa', 'equipe', 'experi√™ncia', 'sobre'])) return 'qualification';
    
    // Check for service-related keywords
    for (const [service, data] of Object.entries(this.knowledgeBase.services)) {
      if (data.keywords.some(keyword => lowerMessage.includes(keyword))) {
        return 'service_inquiry';
      }
    }

    // Check for FAQ patterns
    if (this.knowledgeBase.faqs.some(faq => 
      faq.keywords.some(keyword => lowerMessage.includes(keyword))
    )) {
      return 'faq';
    }

    return 'default';
  }

  private calculateConfidence(message: string, intent: string): number {
    // Simple confidence calculation based on keyword matches
    const lowerMessage = message.toLowerCase();
    let matches = 0;
    let totalKeywords = 0;

    switch (intent) {
      case 'service_inquiry':
        for (const [service, data] of Object.entries(this.knowledgeBase.services)) {
          totalKeywords += data.keywords.length;
          matches += data.keywords.filter(keyword => lowerMessage.includes(keyword)).length;
        }
        break;
      case 'pricing':
        totalKeywords = this.conversationPatterns.pricing.length;
        matches = this.conversationPatterns.pricing.filter(keyword => lowerMessage.includes(keyword)).length;
        break;
      // Add more cases as needed
    }

    return totalKeywords > 0 ? Math.min((matches / totalKeywords) * 100, 95) : 70;
  }

  private isGreeting(message: string): boolean {
    const greetings = ['oi', 'ol√°', 'ola', 'bom dia', 'boa tarde', 'boa noite', 'hello', 'hi', 'hey'];
    return greetings.some(greeting => message.includes(greeting)) && message.length < 50;
  }

  private containsKeywords(message: string, keywords: string[]): boolean {
    return keywords.some(keyword => message.includes(keyword));
  }

  private handleAdvancedGreeting(context: ConversationContext): Partial<ChatMessage> {
    const userName = context.userName ? `, ${context.userName}` : '';
    const timeGreeting = this.getTimeBasedGreeting();
    
    return {
      message: `${timeGreeting}${userName}! üëã Sou o assistente inteligente da Ars Machina Consultancy. \n\nEstou aqui para ajudar voc√™ com:\n‚Ä¢ Informa√ß√µes sobre nossos servi√ßos\n‚Ä¢ Or√ßamentos personalizados\n‚Ä¢ Agendamento de consultas\n‚Ä¢ D√∫vidas t√©cnicas\n\nComo posso ajudar voc√™ hoje?`,
      type: 'quick_reply',
      metadata: {
        quickReplies: [
          { text: 'üíª Desenvolvimento Web', payload: 'service_web', icon: 'üíª' },
          { text: 'üì± Apps Mobile', payload: 'service_mobile', icon: 'üì±' },
          { text: '‚òÅÔ∏è Cloud Computing', payload: 'service_cloud', icon: '‚òÅÔ∏è' },
          { text: 'üí∞ Or√ßamento', payload: 'pricing', icon: 'üí∞' }
        ]
      }
    };
  }

  private getTimeBasedGreeting(): string {
    const hour = new Date().getHours();
    if (hour < 12) return 'Bom dia';
    if (hour < 18) return 'Boa tarde';
    return 'Boa noite';
  }

  private handleAdvancedServiceInquiry(message: string, context: ConversationContext): Partial<ChatMessage> {
    const serviceInterest = context.serviceInterest;
    
    if (serviceInterest && this.knowledgeBase.services[serviceInterest]) {
      const service = this.knowledgeBase.services[serviceInterest];
      
      return {
        message: `üéØ **${service.description}**\n\n` +
                `**Tecnologias:** ${service.technologies.join(', ')}\n\n` +
                `**Projetos recentes:**\n${service.projects.map(p => `‚Ä¢ ${p}`).join('\n')}\n\n` +
                `**Investimento:** ${service.pricing}\n` +
                `**Prazo t√≠pico:** ${service.timeline}\n\n` +
                `Gostaria de saber mais detalhes ou tem algum projeto espec√≠fico em mente?`,
        type: 'quick_reply',
        metadata: {
          quickReplies: [
            { text: 'üí∞ Ver or√ßamento', payload: 'pricing_' + serviceInterest, icon: 'üí∞' },
            { text: 'üìÖ Agendar reuni√£o', payload: 'schedule_meeting', icon: 'üìÖ' },
            { text: 'üìã Mais detalhes', payload: 'more_details_' + serviceInterest, icon: 'üìã' },
            { text: 'üí¨ Falar com especialista', payload: 'contact_specialist', icon: 'üí¨' }
          ]
        }
      };
    }

    return {
      message: `üèóÔ∏è **Nossos Servi√ßos Principais:**\n\n` +
              `üíª **Desenvolvimento Web & Mobile**\n` +
              `‚òÅÔ∏è **Consultoria em Nuvem (AWS, Azure, GCP)**\n` +
              `üîí **Seguran√ßa da Informa√ß√£o**\n` +
              `ü§ñ **Solu√ß√µes de IA & Automa√ß√£o**\n` +
              `üíº **Consultoria T√©cnica & Mentoria**\n\n` +
              `Qual √°rea te interessa mais?`,
      type: 'carousel',
      metadata: {
        carousel: [
          {
            title: 'Desenvolvimento Web',
            subtitle: 'Sites e aplica√ß√µes modernas',
            buttons: [
              { text: 'Saiba mais', payload: 'service_web' },
              { text: 'Ver projetos', payload: 'projects_web' }
            ]
          },
          {
            title: 'Apps Mobile',
            subtitle: 'iOS e Android nativos',
            buttons: [
              { text: 'Saiba mais', payload: 'service_mobile' },
              { text: 'Ver projetos', payload: 'projects_mobile' }
            ]
          },
          {
            title: 'Cloud Computing',
            subtitle: 'AWS, Azure, Google Cloud',
            buttons: [
              { text: 'Saiba mais', payload: 'service_cloud' },
              { text: 'Migra√ß√£o', payload: 'cloud_migration' }
            ]
          }
        ]
      }
    };
  }

  private handleAdvancedPricing(message: string, context: ConversationContext): Partial<ChatMessage> {
    const serviceInterest = context.serviceInterest;
    
    if (serviceInterest && this.knowledgeBase.services[serviceInterest]) {
      const service = this.knowledgeBase.services[serviceInterest];
      
      return {
        message: `üí∞ **Investimento para ${service.description}:**\n\n` +
                `**Valor base:** ${service.pricing}\n` +
                `**Prazo:** ${service.timeline}\n\n` +
                `‚úÖ **Inclu√≠do no or√ßamento:**\n` +
                `‚Ä¢ An√°lise detalhada dos requisitos\n` +
                `‚Ä¢ Desenvolvimento completo\n` +
                `‚Ä¢ Testes e homologa√ß√£o\n` +
                `‚Ä¢ 3 meses de suporte gratuito\n` +
                `‚Ä¢ Documenta√ß√£o t√©cnica\n\n` +
                `Para um or√ßamento personalizado, preciso conhecer melhor seu projeto. Podemos agendar uma conversa?`,
        type: 'quick_reply',
        metadata: {
          quickReplies: [
            { text: 'üìÖ Agendar consulta gratuita', payload: 'schedule_consultation', icon: 'üìÖ' },
            { text: 'üìã Enviar briefing', payload: 'send_brief', icon: 'üìã' },
            { text: 'üí¨ WhatsApp', payload: 'contact_whatsapp', icon: 'üí¨' },
            { text: 'üìß Email', payload: 'contact_email', icon: 'üìß' }
          ]
        }
      };
    }

    return {
      message: `üí∞ **Nossos pre√ßos s√£o personalizados conforme o projeto:**\n\n` +
              `üéØ **Desenvolvimento Web:** A partir de R$ 5.000\n` +
              `üì± **Apps Mobile:** A partir de R$ 8.000\n` +
              `‚òÅÔ∏è **Cloud Computing:** A partir de R$ 3.000\n` +
              `üîí **Ciberseguran√ßa:** A partir de R$ 4.000\n` +
              `ü§ñ **IA & Automa√ß√£o:** A partir de R$ 10.000\n` +
              `üíº **Consultoria:** A partir de R$ 2.000\n\n` +
              `‚úÖ **Sempre inclu√≠do:**\n` +
              `‚Ä¢ Avalia√ß√£o gratuita inicial\n` +
              `‚Ä¢ Or√ßamento detalhado sem compromisso\n` +
              `‚Ä¢ Suporte p√≥s-entrega\n` +
              `‚Ä¢ Garantia de qualidade\n\n` +
              `Qual servi√ßo te interessa para um or√ßamento personalizado?`,
      type: 'quick_reply',
      metadata: {
        quickReplies: [
          { text: 'üíª Web', payload: 'pricing_web', icon: 'üíª' },
          { text: 'üì± Mobile', payload: 'pricing_mobile', icon: 'üì±' },
          { text: '‚òÅÔ∏è Cloud', payload: 'pricing_cloud', icon: '‚òÅÔ∏è' },
          { text: 'üìû Falar com consultor', payload: 'contact_consultant', icon: 'üìû' }
        ]
      }
    };
  }

  private handleTimelineInquiry(message: string, context: ConversationContext): Partial<ChatMessage> {
    return {
      message: `‚è∞ **Prazos t√≠picos dos nossos projetos:**\n\n` +
              `üöÄ **Projetos Simples (1-3 meses):**\n` +
              `‚Ä¢ Landing pages\n` +
              `‚Ä¢ Sites institucionais\n` +
              `‚Ä¢ Consultoria b√°sica\n\n` +
              `‚ö° **Projetos M√©dios (3-6 meses):**\n` +
              `‚Ä¢ E-commerce completo\n` +
              `‚Ä¢ Apps mobile b√°sicos\n` +
              `‚Ä¢ Sistemas de gest√£o\n\n` +
              `üéØ **Projetos Complexos (6-12 meses):**\n` +
              `‚Ä¢ Plataformas enterprise\n` +
              `‚Ä¢ Solu√ß√µes de IA\n` +
              `‚Ä¢ Transforma√ß√£o digital completa\n\n` +
              `O prazo final depende da complexidade e escopo. Quer que eu avalie seu projeto espec√≠fico?`,
      type: 'quick_reply',
      metadata: {
        quickReplies: [
          { text: 'üìã Avaliar meu projeto', payload: 'evaluate_project', icon: 'üìã' },
          { text: '‚ö° Projeto urgente', payload: 'urgent_project', icon: '‚ö°' },
          { text: 'üìÖ Agendar reuni√£o', payload: 'schedule_meeting', icon: 'üìÖ' }
        ]
      }
    };
  }

  private handleAdvancedContact(context: ConversationContext): Partial<ChatMessage> {
    const urgencyText = context.urgency === 'high' ? '\n\n‚ö° **Vejo que √© urgente! Recomendo contato direto via WhatsApp para resposta mais r√°pida.**' : '';
    
    return {
      message: `üìû **Entre em contato conosco:**\n\n` +
              `üì± **WhatsApp:** +55 98 99964-9215\n` +
              `üìß **Email:** contato@arsmachinaconsultancy.com\n` +
              `üåê **Site:** www.arsmachinaconsultancy.com\n` +
              `üìç **Localiza√ß√£o:** S√£o Lu√≠s, Maranh√£o\n\n` +
              `üïí **Hor√°rio de atendimento:**\n` +
              `‚Ä¢ Segunda a Sexta: 9h √†s 18h\n` +
              `‚Ä¢ S√°bado: 9h √†s 12h\n` +
              `‚Ä¢ WhatsApp: 24h (resposta em at√© 2h)${urgencyText}`,
      type: 'quick_reply',
      metadata: {
        quickReplies: [
          { text: 'üí¨ Abrir WhatsApp', payload: 'open_whatsapp', icon: 'üí¨' },
          { text: 'üìß Enviar email', payload: 'send_email', icon: 'üìß' },
          { text: 'üìÖ Agendar reuni√£o', payload: 'schedule_meeting', icon: 'üìÖ' },
          { text: 'üè† Ver localiza√ß√£o', payload: 'view_location', icon: 'üè†' }
        ]
      }
    };
  }

  private handleFAQ(message: string): Partial<ChatMessage> {
    const lowerMessage = message.toLowerCase();
    
    // Find matching FAQ
    const matchingFaq = this.knowledgeBase.faqs.find(faq =>
      faq.keywords.some(keyword => lowerMessage.includes(keyword))
    );

    if (matchingFaq) {
      return {
        message: `‚ùì **${matchingFaq.question}**\n\n${matchingFaq.answer}\n\nTem mais alguma d√∫vida?`,
        type: 'quick_reply',
        metadata: {
          quickReplies: [
            { text: 'üí∞ Pre√ßos', payload: 'pricing', icon: 'üí∞' },
            { text: '‚è∞ Prazos', payload: 'timeline', icon: '‚è∞' },
            { text: 'üõ†Ô∏è Tecnologias', payload: 'technologies', icon: 'üõ†Ô∏è' },
            { text: 'üìû Contato', payload: 'contact', icon: 'üìû' }
          ]
        }
      };
    }

    // Return general FAQ if no specific match
    return {
      message: `‚ùì **Perguntas Frequentes:**\n\n` +
              `‚Ä¢ Quanto tempo leva um projeto?\n` +
              `‚Ä¢ Voc√™s oferecem suporte?\n` +
              `‚Ä¢ Como funciona o processo?\n` +
              `‚Ä¢ Que tecnologias usam?\n\n` +
              `Qual dessas d√∫vidas posso esclarecer?`,
      type: 'quick_reply',
      metadata: {
        quickReplies: [
          { text: '‚è∞ Prazos', payload: 'faq_timeline', icon: '‚è∞' },
          { text: 'üõ†Ô∏è Suporte', payload: 'faq_support', icon: 'üõ†Ô∏è' },
          { text: 'üìã Processo', payload: 'faq_process', icon: 'üìã' },
          { text: 'üíª Tecnologias', payload: 'faq_tech', icon: 'üíª' }
        ]
      }
    };
  }

  private handleProjectDetails(message: string, context: ConversationContext): Partial<ChatMessage> {
    return {
      message: `üöÄ **Vamos falar sobre seu projeto!**\n\n` +
              `Para criar a melhor solu√ß√£o, preciso entender:\n\n` +
              `‚Ä¢ Qual o objetivo principal?\n` +
              `‚Ä¢ Quem √© seu p√∫blico-alvo?\n` +
              `‚Ä¢ Que funcionalidades s√£o essenciais?\n` +
              `‚Ä¢ H√° algum prazo espec√≠fico?\n` +
              `‚Ä¢ Qual seu or√ßamento estimado?\n\n` +
              `Podemos conversar sobre esses detalhes?`,
      type: 'quick_reply',
      metadata: {
        quickReplies: [
          { text: 'üìã Enviar briefing', payload: 'send_brief', icon: 'üìã' },
          { text: 'üìû Ligar agora', payload: 'call_now', icon: 'üìû' },
          { text: 'üìÖ Agendar reuni√£o', payload: 'schedule_meeting', icon: 'üìÖ' },
          { text: 'üí¨ WhatsApp', payload: 'whatsapp_project', icon: 'üí¨' }
        ]
      }
    };
  }

  private handleQualification(message: string, context: ConversationContext): Partial<ChatMessage> {
    const company = this.knowledgeBase.companyInfo;
    
    return {
      message: `üè¢ **Sobre a ${company.name}:**\n\n` +
              `üìÖ **Fundada em:** ${company.founded}\n` +
              `üìç **Localiza√ß√£o:** ${company.location}\n` +
              `üë• **Equipe:** ${company.team}\n` +
              `üéØ **Projetos:** ${company.projects}\n\n` +
              `üåü **Nossas especialidades:**\n` +
              `${company.specialties.map((spec: string) => `‚Ä¢ ${spec}`).join('\n')}\n\n` +
              `Somos uma consultoria jovem e inovadora, focada em entregar resultados excepcionais!`,
      type: 'quick_reply',
      metadata: {
        quickReplies: [
          { text: 'üë• Conhecer equipe', payload: 'meet_team', icon: 'üë•' },
          { text: 'üèÜ Ver projetos', payload: 'view_projects', icon: 'üèÜ' },
          { text: 'üìú Certifica√ß√µes', payload: 'certifications', icon: 'üìú' },
          { text: 'üíº Come√ßar projeto', payload: 'start_project', icon: 'üíº' }
        ]
      }
    };
  }

  private handleIntelligentDefault(message: string, context: ConversationContext): Partial<ChatMessage> {
    const sentiment = this.analyzeSentiment(message);
    const responses = this.getContextualResponses(sentiment, context);
    
    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
    
    return {
      message: randomResponse.message,
      type: 'quick_reply',
      metadata: {
        quickReplies: randomResponse.quickReplies
      }
    };
  }

  private getContextualResponses(sentiment: 'positive' | 'negative' | 'neutral', context: ConversationContext) {
    const baseResponses = {
      positive: [
        {
          message: `üòä Fico feliz em ajudar! Para te dar a melhor orienta√ß√£o, me conte mais sobre o que voc√™ precisa. Sou especialista em solu√ß√µes tecnol√≥gicas.`,
          quickReplies: [
            { text: 'üíª Desenvolvimento', payload: 'service_web', icon: 'üíª' },
            { text: 'üì± Apps', payload: 'service_mobile', icon: 'üì±' },
            { text: '‚òÅÔ∏è Cloud', payload: 'service_cloud', icon: '‚òÅÔ∏è' },
            { text: 'üí∞ Or√ßamento', payload: 'pricing', icon: 'üí∞' }
          ]
        }
      ],
      negative: [
        {
          message: `üòî Entendo sua preocupa√ß√£o. Estou aqui para ajudar a resolver qualquer desafio tecnol√≥gico. Vamos conversar sobre como posso te auxiliar?`,
          quickReplies: [
            { text: 'üÜò Preciso de ajuda', payload: 'need_help', icon: 'üÜò' },
            { text: 'üîß Resolver problema', payload: 'solve_problem', icon: 'üîß' },
            { text: 'üìû Falar com especialista', payload: 'contact_specialist', icon: 'üìû' },
            { text: 'üí¨ WhatsApp urgente', payload: 'urgent_whatsapp', icon: 'üí¨' }
          ]
        }
      ],
      neutral: [
        {
          message: `ü§î Para te ajudar melhor, me conte sobre o que voc√™ est√° procurando. Posso esclarecer d√∫vidas sobre nossos servi√ßos ou ajudar com seu projeto.`,
          quickReplies: [
            { text: 'üèóÔ∏è Nossos servi√ßos', payload: 'services_overview', icon: 'üèóÔ∏è' },
            { text: 'üí° Tenho uma ideia', payload: 'have_idea', icon: 'üí°' },
            { text: '‚ùì Tirar d√∫vidas', payload: 'ask_questions', icon: '‚ùì' },
            { text: 'üìû Falar conosco', payload: 'contact', icon: 'üìû' }
          ]
        }
      ]
    };

    return baseResponses[sentiment];
  }

  // Utility methods
  clearConversation(): void {
    this.conversationHistory.next([]);
    this.context.next({
      sessionId: this.generateSessionId(),
      conversationStage: 'greeting',
      leadScore: 0,
      preferences: {
        language: 'pt',
        communicationStyle: 'casual',
        responseLength: 'detailed'
      }
    });
    this.initializeSession();
  }

  exportConversation(): string {
    const history = this.conversationHistory.value;
    const context = this.context.value;
    
    return JSON.stringify({
      sessionId: context.sessionId,
      timestamp: new Date(),
      messages: history,
      context: context
    }, null, 2);
  }

  getConversationSummary(): any {
    const context = this.context.value;
    const history = this.conversationHistory.value;
    
    return {
      sessionId: context.sessionId,
      messageCount: history.length,
      userMessages: history.filter(m => m.sender === 'user').length,
      botMessages: history.filter(m => m.sender === 'bot').length,
      serviceInterest: context.serviceInterest,
      leadScore: context.leadScore,
      conversationStage: context.conversationStage,
      duration: context.lastActivity ? 
        new Date().getTime() - new Date(context.lastActivity).getTime() : 0
    };
  }
}
